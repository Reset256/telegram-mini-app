<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <h3>Введите текст</h3>
  <input id="textInput" placeholder="Напиши что-нибудь" />
  <button onclick="send()">Отправить</button>

  <script>
    // Инициализация Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.ready();

    // Глобальная функция send
    function send() {
      // Объявляем input внутри функции
      const input = document.getElementById("textInput");
      const text = input.value.trim();
      const user = tg.initDataUnsafe?.user;

      if (!user) {
        alert("Ошибка: user undefined. Откройте Mini App через кнопку бота!");
        return;
      }

      if (!text) {
        alert("Введите текст перед отправкой!");
        return;
      }

      // Отправка на backend
      fetch("https://unmulcted-dobsonfly-modesta.ngrok-free.dev/send-message", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          text,
          userId: user.id
        })
      })
      .then(r => r.json())
      .then(r => {
        console.log("Backend response:", r);
        // ✅ очищаем поле
        input.value = "";
      })
      .catch(e => console.error("Fetch error:", e));
    }
  </script>
</body>
</html>
